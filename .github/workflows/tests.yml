name: tests
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-python@v2
      with:
        python-version: 3.7

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        sudo apt-get install libsndfile1
  
    - name: Demucs - dummy full pipeline
      run: |
        ./make_debug.sh
        python train.py num_workers=1 device=cpu epochs=1 experiment=demucs_1 experiment.scale_factor=2 experiment.demucs.hidden=1 experiment.demucs.depth=3

    - name: Caunet - dummy full pipeline
      run: |
        ./make_debug.sh
        python train.py num_workers=1 device=cpu epochs=1 experiment=caunet_1 experiment.scale_factor=2 experiment.caunet.hidden=8 experiment.caunet.depth=3 experiment.caunet.dense_block_depth=2

    - name: DemucsHifi, no MRF with Disc - dummy full pipeline
      run: |
        ./make_debug.sh
        python train.py num_workers=1 device=cpu epochs=1 experiment.experiment_name=demucs_hifi_no_mrf_with_disc_1 experiment=demucs_hifi experiment.demucs_hifi.num_mrfs=0 experiment.demucs_hifi_bs.l1_factor=100 experiment.demucs_hifi_bs.gen_factor=2 experiment.demucs_hifi.depth=2


  test_setup:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-python@v2
      with:
        python-version: 3.7

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -U .
  
