name: tests
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-python@v2
      with:
        python-version: 3.7

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        sudo apt-get install libsndfile1
  
    - name: Demucs - dummy full pipeline
      run: |
        ./make_debug.sh
        python train.py num_workers=1 device=cpu epochs=1 experiment=demucs_1 experiment.scale_factor=2 experiment.demucs.hidden=1 experiment.demucs.depth=3

    - name: Demucs With Transformer - dummy full pipeline
      run: |
        ./make_debug.sh
        python train.py num_workers=1 device=cpu epochs=1 experiment=demucs_with_transformer_1 experiment.scale_factor=2 experiment.batch_size=1 experiment.demucs_with_transformer.hidden=4 experiment.demucs_with_transformer.depth=3

    - name: Caunet - dummy full pipeline
      run: |
        ./make_debug.sh
        python train.py num_workers=1 device=cpu epochs=1 experiment=caunet_1 experiment.scale_factor=2 experiment.caunet.hidden=8 experiment.caunet.depth=3 experiment.caunet.dense_block_depth=2


    - name: Demucs HiFi - dummy full pipeline
      run: |
        ./make_debug.sh
        python train.py num_workers=2 device=cpu epochs=1 experiment=demucs_hifi experiment.scale_factor=2 eval_every=1


  test_setup:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-python@v2
      with:
        python-version: 3.7

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -U .
  
